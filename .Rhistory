# Iterate through each game to calculate elo_change and total_elo_change
for (i in 1:nrow(result_df)) {
game_type <- result_df[i, "ChessGameType"]
white_player <- result_df[i, "White"]
black_player <- result_df[i, "Black"]
white_elo <- as.integer(result_df[i, "WhiteElo"])
black_elo <- as.integer(result_df[i, "BlackElo"])
game_year <- format(as.Date(result_df[i, "Date"], format="%Y-%m-%d"), "%Y")
# Initialize last Elos, last total Elo change, and last year for the game type if not already done
if (is.null(last_elos_by_type[[game_type]])) {
last_elos_by_type[[game_type]] <- NA
}
if (is.null(last_total_elo_change_by_type[[game_type]])) {
last_total_elo_change_by_type[[game_type]] <- 0
}
if (is.null(last_year_by_type[[game_type]])) {
last_year_by_type[[game_type]] <- game_year
}
# Reset cumulative elo change at the start of a new year
if (game_year != last_year_by_type[[game_type]]) {
cumulative_elo_change <- 0
}
# Determine if the current game involves the tracked player
if (white_player == chess_username) {
current_elo <- white_elo
opponent_elo <- black_elo
} else if (black_player == chess_username) {
current_elo <- black_elo
opponent_elo <- white_elo
} else {
# If the tracked player is not involved in the current game, continue to the next iteration
next
}
# Calculate elo_change for the current game type
if (is.na(last_elos_by_type[[game_type]])) {
result_df[i, "elo_change"] <- 0
} else {
previous_elo <- last_elos_by_type[[game_type]]
result_df[i, "elo_change"] <- current_elo - previous_elo
}
# Calculate the total_elo_change considering the last total Elo change for the game type
cumulative_elo_change <- last_total_elo_change_by_type[[game_type]] + result_df[i, "elo_change"]
result_df[i, "total_elo_change"] <- cumulative_elo_change
# Update the last Elo, last total Elo change, and last year for the game type
last_elos_by_type[[game_type]] <- current_elo
last_total_elo_change_by_type[[game_type]] <- cumulative_elo_change
last_year_by_type[[game_type]] <- game_year
}
result_df$Date <- as.Date(result_df$Date, format = "%Y-%m-%d")
# Define the chess username
chess_username <- "owej9023"
result_df$elo_change <- NA
result_df$total_elo_change <- NA
# Initialize variables to track cumulative Elo change, last Elos by game type, and last game years by game type
cumulative_elo_change <- 0
last_elos_by_type <- list()
last_total_elo_change_by_type <- list()
last_year_by_type <- list()
result_df$Date <- as.Date(result_df$Date, format = "%Y-%m-%d")
# Iterate through each game to calculate elo_change and total_elo_change
for (i in 1:nrow(result_df)) {
game_type <- result_df[i, "ChessGameType"]
white_player <- result_df[i, "White"]
black_player <- result_df[i, "Black"]
white_elo <- as.integer(result_df[i, "WhiteElo"])
black_elo <- as.integer(result_df[i, "BlackElo"])
# Initialize last Elos, last total Elo change, and last year for the game type if not already done
if (is.null(last_elos_by_type[[game_type]])) {
last_elos_by_type[[game_type]] <- NA
}
if (is.null(last_total_elo_change_by_type[[game_type]])) {
last_total_elo_change_by_type[[game_type]] <- 0
}
if (is.null(last_year_by_type[[game_type]])) {
last_year_by_type[[game_type]] <- game_year
}
# Reset cumulative elo change at the start of a new year
if (game_year != last_year_by_type[[game_type]]) {
cumulative_elo_change <- 0
}
# Determine if the current game involves the tracked player
if (white_player == chess_username) {
current_elo <- white_elo
opponent_elo <- black_elo
} else if (black_player == chess_username) {
current_elo <- black_elo
opponent_elo <- white_elo
} else {
# If the tracked player is not involved in the current game, continue to the next iteration
next
}
# Calculate elo_change for the current game type
if (is.na(last_elos_by_type[[game_type]])) {
result_df[i, "elo_change"] <- 0
} else {
previous_elo <- last_elos_by_type[[game_type]]
result_df[i, "elo_change"] <- current_elo - previous_elo
}
# Calculate the total_elo_change considering the last total Elo change for the game type
cumulative_elo_change <- last_total_elo_change_by_type[[game_type]] + result_df[i, "elo_change"]
result_df[i, "total_elo_change"] <- cumulative_elo_change
# Update the last Elo, last total Elo change, and last year for the game type
last_elos_by_type[[game_type]] <- current_elo
last_total_elo_change_by_type[[game_type]] <- cumulative_elo_change
last_year_by_type[[game_type]] <- game_year
}
runApp()
# Define the chess username
chess_username <- "owej9023"
result_df$elo_change <- NA
result_df$total_elo_change <- NA
# Initialize variables to track cumulative Elo change, last Elos by game type, and last game years by game type
cumulative_elo_change <- 0
last_elos_by_type <- list()
last_total_elo_change_by_type <- list()
last_year_by_type <- list()
result_df$Date <- as.Date(result_df$Date, format = "%Y-%m-%d")
# Iterate through each game to calculate elo_change and total_elo_change
for (i in 1:nrow(result_df)) {
game_type <- result_df[i, "ChessGameType"]
white_player <- result_df[i, "White"]
black_player <- result_df[i, "Black"]
white_elo <- as.integer(result_df[i, "WhiteElo"])
black_elo <- as.integer(result_df[i, "BlackElo"])
# Initialize last Elos, last total Elo change, and last year for the game type if not already done
if (is.null(last_elos_by_type[[game_type]])) {
last_elos_by_type[[game_type]] <- NA
}
if (is.null(last_total_elo_change_by_type[[game_type]])) {
last_total_elo_change_by_type[[game_type]] <- 0
}
if (is.null(last_year_by_type[[game_type]])) {
last_year_by_type[[game_type]] <- game_year
}
# Reset cumulative elo change at the start of a new year
if (game_year != last_year_by_type[[game_type]]) {
cumulative_elo_change <- 0
}
# Determine if the current game involves the tracked player
if (white_player == chess_username) {
current_elo <- white_elo
opponent_elo <- black_elo
} else if (black_player == chess_username) {
current_elo <- black_elo
opponent_elo <- white_elo
} else {
# If the tracked player is not involved in the current game, continue to the next iteration
next
}
# Calculate elo_change for the current game type
if (is.na(last_elos_by_type[[game_type]])) {
result_df[i, "elo_change"] <- 0
} else {
previous_elo <- last_elos_by_type[[game_type]]
result_df[i, "elo_change"] <- current_elo - previous_elo
}
# Calculate the total_elo_change considering the last total Elo change for the game type
cumulative_elo_change <- last_total_elo_change_by_type[[game_type]] + result_df[i, "elo_change"]
result_df[i, "total_elo_change"] <- cumulative_elo_change
# Update the last Elo, last total Elo change, and last year for the game type
last_elos_by_type[[game_type]] <- current_elo
last_total_elo_change_by_type[[game_type]] <- cumulative_elo_change
last_year_by_type[[game_type]] <- game_year
}
# Define the chess username
chess_username <- "owej9023"
# Create a copy of the last 100 rows of result_df for testing
result_df_test <- tail(result_df, 100)
result_df_test$elo_change <- NA
result_df_test$total_elo_change <- NA
# Initialize variables to track cumulative Elo change and last Elos by game type
cumulative_elo_change <- 0
last_elos_by_type <- list()
last_total_elo_change_by_type <- list()
# Iterate through each game to calculate elo_change and total_elo_change
for (i in 1:nrow(result_df_test)) {
game_type <- result_df_test[i, "ChessGameType"]
white_player <- result_df_test[i, "White"]
black_player <- result_df_test[i, "Black"]
white_elo <- as.integer(result_df_test[i, "WhiteElo"])
black_elo <- as.integer(result_df_test[i, "BlackElo"])
# Initialize last Elos and last total Elo change for the game type if not already done
if (is.null(last_elos_by_type[[game_type]])) {
last_elos_by_type[[game_type]] <- list()
}
if (is.null(last_total_elo_change_by_type[[game_type]])) {
last_total_elo_change_by_type[[game_type]] <- 0
}
# Determine if the current game involves the tracked player
if (white_player == chess_username) {
current_elo <- white_elo
opponent_elo <- black_elo
} else if (black_player == chess_username) {
current_elo <- black_elo
opponent_elo <- white_elo
} else {
# If the tracked player is not involved in the current game, continue to the next iteration
next
}
# Calculate elo_change for the current game type
if (is.null(last_elos_by_type[[game_type]][[chess_username]])) {
result_df_test[i, "elo_change"] <- 0
} else {
previous_elo <- last_elos_by_type[[game_type]][[chess_username]]
result_df_test[i, "elo_change"] <- current_elo - previous_elo
}
# Calculate the total_elo_change considering the last total Elo change for the game type
cumulative_elo_change <- last_total_elo_change_by_type[[game_type]] + result_df_test[i, "elo_change"]
result_df_test[i, "total_elo_change"] <- cumulative_elo_change
# Update the last Elo and last total Elo change for the game type
last_elos_by_type[[game_type]][[chess_username]] <- current_elo
last_total_elo_change_by_type[[game_type]] <- cumulative_elo_change
}
# Define the chess username
chess_username <- "owej9023"
# Create a copy of the last 100 rows of result_df for testing
result_df_test <- tail(result_df, 100)
result_df_test$elo_change <- NA
result_df_test$total_elo_change <- NA
# Initialize variables to track cumulative Elo change and last Elos by game type
cumulative_elo_change <- 0
last_elos_by_type <- list()
last_total_elo_change_by_type <- list()
# Iterate through each game to calculate elo_change and total_elo_change
for (i in 1:nrow(result_df_test)) {
game_type <- result_df_test[i, "ChessGameType"]
white_player <- result_df_test[i, "White"]
black_player <- result_df_test[i, "Black"]
white_elo <- as.integer(result_df_test[i, "WhiteElo"])
black_elo <- as.integer(result_df_test[i, "BlackElo"])
# Initialize last Elos and last total Elo change for the game type if not already done
if (is.null(last_elos_by_type[[game_type]])) {
last_elos_by_type[[game_type]] <- list()
}
if (is.null(last_total_elo_change_by_type[[game_type]])) {
last_total_elo_change_by_type[[game_type]] <- 0
}
# Determine if the current game involves the tracked player
if (white_player == chess_username) {
current_elo <- white_elo
opponent_elo <- black_elo
} else if (black_player == chess_username) {
current_elo <- black_elo
opponent_elo <- white_elo
} else {
# If the tracked player is not involved in the current game, continue to the next iteration
next
}
# Calculate elo_change for the current game type
if (is.null(last_elos_by_type[[game_type]][[chess_username]])) {
result_df_test[i, "elo_change"] <- 0
} else {
previous_elo <- last_elos_by_type[[game_type]][[chess_username]]
result_df_test[i, "elo_change"] <- current_elo - previous_elo
}
# Calculate the total_elo_change considering the last total Elo change for the game type
cumulative_elo_change <- last_total_elo_change_by_type[[game_type]] + result_df_test[i, "elo_change"]
result_df_test[i, "total_elo_change"] <- cumulative_elo_change
# Update the last Elo and last total Elo change for the game type
last_elos_by_type[[game_type]][[chess_username]] <- current_elo
last_total_elo_change_by_type[[game_type]] <- cumulative_elo_change
}
# Function to extract values from the PGN string
extract_pgn_values <- function(pgn) {
# Split the PGN string into lines
pgn_lines <- strsplit(pgn, "\n")[[1]]
# Extract the metadata (everything between square brackets)
metadata <- pgn_lines[grep("^\\[", pgn_lines)]
metadata_values <- sapply(metadata, function(line) {
key_value <- gsub("^\\[|\\]$", "", line)
key_value_split <- strsplit(key_value, " \"")[[1]]
value <- gsub("\"$", "", key_value_split[2])
return(value)
})
names(metadata_values) <- sapply(metadata, function(line) {
key_value <- gsub("^\\[|\\]$", "", line)
key_value_split <- strsplit(key_value, " \"")[[1]]
return(key_value_split[1])
})
# Extract the moves (everything after the blank line)
moves_index <- which(pgn_lines == "")
if (length(moves_index) > 0) {
moves <- pgn_lines[(moves_index[1] + 1):length(pgn_lines)]
moves <- paste(moves, collapse = " ")
} else {
moves <- ""
}
# Combine the metadata and moves into a single list
pgn_values <- c(metadata_values, list(moves = moves))
return(pgn_values)
}
# Function to clean date values
clean_dates <- function(dates) {
return(as.Date(gsub("\\[Date \"|\"\\]", "", dates), format = "%Y.%m.%d"))
}
# Function to clean result values
clean_results <- function(results) {
return(regmatches(results, regexpr("\\d+/\\d+-\\d+/\\d+|\\d+-\\d+", results))[[1]])
}
# Function to clean Elo values
clean_elo <- function(elo) {
return(as.numeric(gsub("\\D", "", elo)))
}
# Function to clean time values
clean_time <- function(time) {
return(hms::as_hms(regmatches(time, regexpr("\\d{2}:\\d{2}:\\d{2}", time))[[1]]))
}
# Function to clean usernames
clean_usernames <- function(user_string) {
return(sub("\\[.*?\"(.*?)\"\\]", "\\1", user_string))
}
chess_username <- "owej9023"
desired_rows <- 5000000
game_types <- c("Blitz","Bullet")
api_url <- paste0("https://api.chess.com/pub/player/", chess_username, "/games/archives")
archives <- jsonlite::fromJSON(content(GET(api_url), "text"))
# Fetch and combine game data from all archives
# Fetch and combine game data from all archives
archive_data <- list()
total_archives <- length(archives$archives)
for (i in seq_along(archives$archives)) {
archive_data[[i]] <- jsonlite::fromJSON(content(GET(archives$archives[i]), "text", flatten = TRUE))
}
combined_df <- bind_rows(archive_data) %>%
filter(grepl(paste(game_types, collapse = "|"), games$time_class, ignore.case = TRUE),
games$rules == "chess",
games$rated == TRUE)
result_list <- lapply(seq_len(nrow(combined_df$games)), function(i) {
pgn_values <- extract_pgn_values(combined_df$games$pgn[i])
pgn_values <- as.data.frame(t(pgn_values), stringsAsFactors = FALSE)
pgn_values$ChessGameType <- combined_df$games$time_class[i]
return(pgn_values)
})
result_df <- bind_rows(result_list) %>% na.omit()
if (desired_rows < nrow(result_df)) {
result_df <- tail(result_df, desired_rows)
}
result_df <- bind_rows(result_list) %>% na.omit()
if (desired_rows < nrow(result_df)) {
result_df <- tail(result_df, desired_rows)
}
result_df$Date <- clean_dates(result_df$Date)
result_df$Date <- as.Date(result_df$Date)
result_df$Result <- sapply(result_df$Result, clean_results)
#result_df[, c(WhiteElo, BlackElo)] <- sapply(result_df[, c(WhiteElo, BlackElo)], clean_elo)
#result_df$V16 <- sapply(result_df$V16, clean_elo)
#result_df[, c(18, 20)] <- lapply(result_df[, c(18, 20)], clean_time)
#result_df[, c(5, 6)] <- sapply(result_df[, c(5, 6)], clean_usernames)
result_df$elo_change <- NA
result_df$total_elo_change <- NA
for (i in 1:nrow(result_df)) {
if (result_df[i, "White"] == chess_username) {
current_elo <- result_df[i, "WhiteElo"]
opponent_elo <- result_df[i, "BlackElo"]
} else if (result_df[i, "Black"] == chess_username) {
current_elo <- result_df[i, "WhiteElo"]
opponent_elo <- result_df[i, "BlackElo"]
} else {
next
}
if (i == 1) {
result_df[i, "elo_change"] <- 0
} else {
previous_elo <- ifelse(result_df[i - 1, "White"] == chess_username,
result_df[i - 1, "WhiteElo"],
result_df[i - 1, "BlackElo"])
elo_change <- as.integer(current_elo) - as.integer(previous_elo)
result_df[i, "elo_change"] <- elo_change
}
}
result_df$total_elo_change <- ave(result_df$elo_change, result_df$Date, FUN = cumsum)
result_df$elo_change[is.na(result_df$elo_change)] <- 0
result_df <- result_df %>%
group_by(Date) %>%
mutate(total_elo_change = last(total_elo_change)) %>%
ungroup() %>%
mutate(
day_of_week = factor(weekdays(Date), levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
chess_username = ifelse(chess_username %in% c(White, Black), as.numeric(ifelse(chess_username %in% White, WhiteElo, BlackElo)), NA_real_),
hour = ((StartTime)),
hourend = (EndTime),
game_number = row_number(),
game_type = result_df$ChessGameType
) %>%
select(-Termination, -Link)
result_df$year <- year(result_df$Date)
result_df$week <- week(result_df$Date)
result_df$month <- month(result_df$Date)
summary_week <- result_df %>%
group_by(year, week, game_type) %>%
summarize(
mean_week_elo = mean(total_elo_change, na.rm = TRUE),
sd_week_elo = sd(total_elo_change, na.rm = TRUE),
count = n(),
sem_week_elo = sd(total_elo_change, na.rm = TRUE) / sqrt(n())
)
summary_month <- result_df %>%
group_by(year, month, game_type) %>%
summarize(
mean_month_elo = mean(total_elo_change, na.rm = TRUE),
sd_month_elo = sd(total_elo_change, na.rm = TRUE),
count = n(),
sem_month_elo = sd(total_elo_change, na.rm = TRUE) / sqrt(n())
)
summary_year <- result_df %>%
group_by(year, game_type) %>%
summarize(
mean_year_elo = mean(total_elo_change, na.rm = TRUE),
sd_year_elo = sd(total_elo_change, na.rm = TRUE),
count = n(),
sem_year_elo = sd(total_elo_change, na.rm = TRUE) / sqrt(n())
)
# Define the chess username
chess_username <- "owej9023"
# Create a copy of the last 100 rows of result_df for testing
result_df_test <- tail(result_df, 100)
result_df_test$elo_change <- NA
result_df_test$total_elo_change <- NA
# Initialize variables to track cumulative Elo change and last Elos by game type
cumulative_elo_change <- 0
last_elos_by_type <- list()
last_total_elo_change_by_type <- list()
# Iterate through each game to calculate elo_change and total_elo_change
for (i in 1:nrow(result_df_test)) {
game_type <- result_df_test[i, "ChessGameType"]
white_player <- result_df_test[i, "White"]
black_player <- result_df_test[i, "Black"]
white_elo <- as.integer(result_df_test[i, "WhiteElo"])
black_elo <- as.integer(result_df_test[i, "BlackElo"])
# Initialize last Elos and last total Elo change for the game type if not already done
if (is.null(last_elos_by_type[[game_type]])) {
last_elos_by_type[[game_type]] <- list()
}
if (is.null(last_total_elo_change_by_type[[game_type]])) {
last_total_elo_change_by_type[[game_type]] <- 0
}
# Determine if the current game involves the tracked player
if (white_player == chess_username) {
current_elo <- white_elo
opponent_elo <- black_elo
} else if (black_player == chess_username) {
current_elo <- black_elo
opponent_elo <- white_elo
} else {
# If the tracked player is not involved in the current game, continue to the next iteration
next
}
# Calculate elo_change for the current game type
if (is.null(last_elos_by_type[[game_type]][[chess_username]])) {
result_df_test[i, "elo_change"] <- 0
} else {
previous_elo <- last_elos_by_type[[game_type]][[chess_username]]
result_df_test[i, "elo_change"] <- current_elo - previous_elo
}
# Calculate the total_elo_change considering the last total Elo change for the game type
cumulative_elo_change <- last_total_elo_change_by_type[[game_type]] + result_df_test[i, "elo_change"]
result_df_test[i, "total_elo_change"] <- cumulative_elo_change
# Update the last Elo and last total Elo change for the game type
last_elos_by_type[[game_type]][[chess_username]] <- current_elo
last_total_elo_change_by_type[[game_type]] <- cumulative_elo_change
}
Define the chess username
# Define the chess username
chess_username <- "owej9023"
# Create a copy of the last 100 rows of result_df for testing
resul#t_df_test <- tail(result_df, 100)
# Define the chess username
chess_username <- "owej9023"
# Create a copy of the last 100 rows of result_df for testing
result_df_test <- tail(result_df, 100)
result_df_test$elo_change <- NA
result_df_test$total_elo_change <- NA
# Initialize variables to track cumulative Elo change and last Elos by game type
cumulative_elo_change <- 0
last_elos_by_type <- list()
# Iterate through each game to calculate elo_change and total_elo_change
for (i in 1:nrow(result_df_test)) {
game_type <- result_df_test[i, "ChessGameType"]
white_player <- result_df_test[i, "White"]
black_player <- result_df_test[i, "Black"]
white_elo <- as.integer(result_df_test[i, "WhiteElo"])
black_elo <- as.integer(result_df_test[i, "BlackElo"])
# Initialize last Elos for the game type if not already done
if (is.null(last_elos_by_type[[game_type]])) {
last_elos_by_type[[game_type]] <- list()
}
# Determine if the current game involves the tracked player
if (white_player == chess_username) {
current_elo <- white_elo
opponent_elo <- black_elo
} else if (black_player == chess_username) {
current_elo <- black_elo
opponent_elo <- white_elo
} else {
# If the tracked player is not involved in the current game, continue to the next iteration
next
}
# Calculate elo_change for the current game type
if (is.null(last_elos_by_type[[game_type]][[chess_username]])) {
result_df_test[i, "elo_change"] <- 0
} else {
previous_elo <- last_elos_by_type[[game_type]][[chess_username]]
result_df_test[i, "elo_change"] <- current_elo - previous_elo
}
# Update cumulative_elo_change
cumulative_elo_change <- cumulative_elo_change + result_df_test[i, "elo_change"]
result_df_test[i, "total_elo_change"] <- cumulative_elo_change
# Update the last Elo for the game type
last_elos_by_type[[game_type]][[chess_username]] <- current_elo
}
runApp()
runApp()
